name: Function Tests (Docker)

on:
  workflow_call:
    inputs:
      function_name:
        description: "Имя функции для проверки (без расширения)"
        required: true
        type: string
    secrets:
      OPENROUTER_API_KEY:
        required: true

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      # Чекаутим вызывающий репозиторий (с функцией)
      - name: Checkout function repo
        uses: actions/checkout@v4

      # Собираем образ из текущего репо (где лежит Dockerfile)
      - name: Build Docker image
        run: docker build -t function-tests .

      # Запускаем контейнер и монтируем код из вызывающего репо внутрь
      - name: Run tests in Docker
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          docker run --rm \
            -e OPENROUTER_API_KEY=$OPENROUTER_API_KEY \
            -v $GITHUB_WORKSPACE:/app \
            function-tests \
            --function "/app/${{ inputs.function_name }}.py" \
            --schema "/app/${{ inputs.function_name }}.json" \
            --tests "/app/${{ inputs.function_name }}.yaml"
